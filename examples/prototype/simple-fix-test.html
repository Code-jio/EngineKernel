<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>简化的THREE.js冲突测试</title>
        <style>
            body { 
                margin: 0; 
                padding: 20px; 
                font-family: Arial, sans-serif;
                background: #f0f0f0;
            }
            .info { 
                background: white; 
                padding: 20px; 
                margin-bottom: 20px; 
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            .success { color: #28a745; font-weight: bold; }
            .error { color: #dc3545; font-weight: bold; }
            .warning { color: #ffc107; font-weight: bold; }
            #container { 
                width: 100%; 
                height: 400px; 
                border: 2px solid #ddd;
                border-radius: 8px;
                background: #222;
            }
            .status { margin: 10px 0; }
        </style>
    </head>
    <body>
        <div class="info">
            <h2>THREE.js多实例问题简化测试</h2>
            <p>如果你看到控制台有"Multiple instances"警告，请按照以下步骤解决：</p>
            
            <div id="status-container">
                <div class="status" id="step1">🔍 步骤1: 检查EngineKernel加载状态...</div>
                <div class="status" id="step2">⏳ 步骤2: 等待检查THREE对象...</div>
                <div class="status" id="step3">⏳ 步骤3: 等待创建3D场景...</div>
                <div class="status" id="step4">⏳ 步骤4: 等待启动动画...</div>
            </div>
            
            <h3>手动解决方案：</h3>
            <ol>
                <li><strong>检查开发服务器：</strong> 确保 <code>npm run dev</code> 在EngineKernel目录运行</li>
                <li><strong>清理缓存：</strong> 按Ctrl+Shift+Delete清理浏览器缓存</li>
                <li><strong>检查控制台：</strong> 查看具体的错误信息</li>
                <li><strong>重新加载：</strong> 刷新页面重试</li>
            </ol>
        </div>
        
        <canvas id="container"></canvas>
        
        <!-- 尝试加载开发版本，如果失败则使用min版本 -->
        <script>
            let step1 = document.getElementById('step1');
            let step2 = document.getElementById('step2');
            let step3 = document.getElementById('step3');
            let step4 = document.getElementById('step4');
            
            function updateStatus(stepId, message, type = 'info') {
                const element = document.getElementById(stepId);
                const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'warning';
                element.innerHTML = message;
                element.className = `status ${className}`;
            }
            
            // 动态加载EngineKernel脚本
            function loadEngineKernel() {
                return new Promise((resolve, reject) => {
                    // 首先尝试开发版本
                    const devScript = document.createElement('script');
                    devScript.src = 'http://localhost:8000/engine-kernel.dev.js';
                    devScript.onload = () => {
                        updateStatus('step1', '✅ EngineKernel开发版本加载成功', 'success');
                        resolve('dev');
                    };
                    devScript.onerror = () => {
                        console.log('开发版本加载失败，尝试min版本...');
                        document.head.removeChild(devScript);
                        
                        // 尝试min版本
                        const minScript = document.createElement('script');
                        minScript.src = './../../dist/engine-kernel.min.js';
                        minScript.onload = () => {
                            updateStatus('step1', '✅ EngineKernel min版本加载成功', 'success');
                            resolve('min');
                        };
                        minScript.onerror = () => {
                            updateStatus('step1', '❌ EngineKernel加载失败', 'error');
                            reject(new Error('无法加载EngineKernel'));
                        };
                        document.head.appendChild(minScript);
                    };
                    document.head.appendChild(devScript);
                });
            }
            
            // 初始化测试
            async function initTest() {
                try {
                    // 加载EngineKernel
                    await loadEngineKernel();
                    
                    // 检查THREE对象
                    updateStatus('step2', '🔍 检查THREE对象...', 'warning');
                    
                    if (!window.EngineKernel) {
                        throw new Error('EngineKernel未正确加载到全局对象');
                    }
                    
                    if (!window.EngineKernel.THREE) {
                        throw new Error('EngineKernel.THREE不可用');
                    }
                    
                    const THREE = window.EngineKernel.THREE;
                    updateStatus('step2', `✅ THREE对象可用，版本: ${THREE.REVISION}`, 'success');
                    
                    // 创建3D场景
                    updateStatus('step3', '🎨 创建3D场景...', 'warning');
                    
                    const scene = new THREE.Scene();
                    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / 400, 0.1, 1000);
                    const renderer = new THREE.WebGLRenderer({ 
                        canvas: document.getElementById('container'),
                        antialias: true 
                    });
                    
                    renderer.setSize(window.innerWidth - 40, 400);
                    renderer.setClearColor(0x2c3e50);
                    
                    // 创建旋转立方体
                    const geometry = new THREE.BoxGeometry(1.5, 1.5, 1.5);
                    const material = new THREE.MeshPhongMaterial({ 
                        color: 0x3498db,
                        shininess: 100 
                    });
                    const cube = new THREE.Mesh(geometry, material);
                    scene.add(cube);
                    
                    // 添加光源
                    const ambientLight = new THREE.AmbientLight(0x404040, 0.4);
                    scene.add(ambientLight);
                    
                    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                    directionalLight.position.set(1, 1, 1);
                    scene.add(directionalLight);
                    
                    camera.position.z = 3;
                    
                    updateStatus('step3', '✅ 3D场景创建成功', 'success');
                    
                    // 启动动画
                    updateStatus('step4', '🎬 启动动画...', 'warning');
                    
                    function animate() {
                        requestAnimationFrame(animate);
                        
                        cube.rotation.x += 0.01;
                        cube.rotation.y += 0.01;
                        
                        renderer.render(scene, camera);
                    }
                    
                    animate();
                    updateStatus('step4', '✅ 动画启动成功！如果看到旋转立方体，说明一切正常！', 'success');
                    
                    // 检查是否有警告
                    setTimeout(() => {
                        console.log('🎉 测试完成！如果控制台没有"Multiple instances"警告，说明问题已解决！');
                    }, 3000);
                    
                } catch (error) {
                    console.error('测试失败:', error);
                    updateStatus('step1', `❌ 错误: ${error.message}`, 'error');
                    
                    // 提供故障排除建议
                    const container = document.getElementById('status-container');
                    container.innerHTML += `
                        <div class="status error">
                            <h4>故障排除建议：</h4>
                            <ul>
                                <li>确保在EngineKernel目录运行了 <code>npm run dev</code></li>
                                <li>检查控制台的详细错误信息</li>
                                <li>清理浏览器缓存后重试</li>
                                <li>确认dist/engine-kernel.min.js文件存在</li>
                            </ul>
                        </div>
                    `;
                }
            }
            
            // 启动测试
            initTest();
        </script>
    </body>
</html> 