<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>EngineKernel 原型验证</title>
        <link rel="stylesheet" href="./index.css" />
    </head>
    <body>
        <div class="control-panel">
            <button id="switchPerspective">透视相机</button>
            <button id="switchOrtho">正交相机</button>
            <div id="fpsCounter"></div>
        </div>
        <canvas id="container"></canvas>

        <!-- <script src="./dev.js"></script> -->
        <script src="http://localhost:8080/engine-kernel.dev.js"></script>
        <script>
            const engine = new EngineKernel.Core({
                container: "#viewport",
                plugins: [
                    {
                        name: "CameraPlugin",
                        path: "/plugins/camera",
                        pluginClass: EngineKernel.CameraPlugin,
                        userData: {
                            cameraConfig: {
                                type: "perspective",
                                fov: 45,
                                near: 0.1,
                                far: 1000,
                                position: [0, 0, 5],
                                lookAt: [0, 0, 0],
                            },
                        },
                    },
                    {
                        name: "ResourceReaderPlugin",
                        path: "/plugins/ResourceReaderPlugin",
                        basePath: "/assets/models",
                        url: "/assets/models",
                        supportedFormats: ["gltf", "fbx"],
                        pluginClass: EngineKernel.ResourceReaderPlugin,
                        userData: {
                            
                        },
                    },
                    {
                        name: "BaseScene",
                        path: "/plugins/scene",
                        container: "#viewport",
                        pluginClass: EngineKernel.BaseScene,
                        userData: {
                            rendererConfig: {
                                container: document.getElementById("container"),
                                antialias: true,
                                alpha: false,
                                clearColor: 0x444444
                            },
                            cameraConfig: {
                                type: "perspective",
                                fov: 45,
                                near: 0.1,
                                far: 1000,
                                position: [0, 0, 5],
                                lookAt: [0, 0, 0],
                            },
                            lightConfig: {
                                ambientLight: {
                                    color: 0xffffff,
                                    intensity: 0.5
                                },
                                directionalLight: {
                                    color: 0xffffff,
                                    intensity: 1,
                                    position: [10, 10, 10]
                                }
                            }
                        },
                    },
                    
                ],
            })
            
            console.log("EngineKernel 实例:", engine) // 打印 EngineKernel 实例

            // 注册渲染循环插件
            engine.registerPlugin({
                name: "RenderLoopPlugin",
                path: "/plugins/webgl/renderLoop",
                pluginClass: EngineKernel.RenderLoop,
                userData: {},
            })

            engine.eventBus.on("init-complete", () => {
                console.log("场景初始化完成，当前场景对象:", engine.getPlugin("BaseScene"))
                let gltfLoader = engine.getPlugin('ResourceReaderPlugin').gltfLoader;

                gltfLoader.load('./model/Horse.glb', (gltf) => {
                    console.log("gltf", gltf)
                    gltf.scene.scale.set(0.01, 0.01, 0.01); // 调整模型大小
                    gltf.scene.position.set(0, 0, 0);
                    
                    // 调试模型材质
                    gltf.scene.traverse(child => {
                        if (child.material) {
                            console.log('模型材质:', child.material);
                            child.material.needsUpdate = true;
                        }
                    });

                    // 添加模型到场景
                    engine.getPlugin("BaseScene").scene.add(gltf.scene);
                })

                // 渲染循环
                engine.getPlugin("RenderLoopPlugin").initialize()
            })

            // 相机切换控制
            document.getElementById("switchPerspective").onclick = () => {
                engine.getPlugin("CameraService").switchType("perspective")
            }
            document.getElementById("switchOrtho").onclick = () => {
                engine.getPlugin("CameraService").switchType("orthographic")
            }
        </script>
    </body>
</html>
