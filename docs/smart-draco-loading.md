# é¢„æ£€æµ‹DRACOåŠ è½½ç³»ç»Ÿ

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

é¢„æ£€æµ‹DRACOåŠ è½½ç³»ç»Ÿé€šè¿‡åˆ†ææ–‡ä»¶å¤´ä¿¡æ¯æ¥åˆ¤æ–­3Dæ¨¡å‹æ˜¯å¦éœ€è¦DRACOè§£å‹å™¨ï¼Œåœ¨åŠ è½½å‰å°±åšå‡ºæ­£ç¡®å†³ç­–ï¼Œé¿å…äº†"å°è¯•-å¤±è´¥-é‡è¯•"çš„å¼€é”€ï¼Œå¤§å¹…æå‡åŠ è½½æ€§èƒ½ã€‚

## ğŸš€ æ ¸å¿ƒç‰¹æ€§

### **1. æ–‡ä»¶å¤´é¢„æ£€æµ‹**
- âœ… **GLBæ ¼å¼æ”¯æŒ**ï¼šè§£æGLBæ–‡ä»¶å¤´ï¼Œè¯»å–JSONå—æ£€æµ‹DRACOæ‰©å±•
- âœ… **GLTFæ ¼å¼æ”¯æŒ**ï¼šè§£æJSONå†…å®¹ï¼Œæ£€æŸ¥extensionsUsedå’ŒextensionsRequired
- âœ… **ç²¾ç¡®æ£€æµ‹**ï¼šè¯†åˆ«KHR_draco_mesh_compressionæ‰©å±•å£°æ˜
- âœ… **å®¹é”™æœºåˆ¶**ï¼šæ£€æµ‹å¤±è´¥æ—¶è‡ªåŠ¨é™çº§åˆ°åŸºç¡€åŠ è½½å™¨

### **2. é«˜æ•ˆç¼“å­˜ç³»ç»Ÿ**
- âœ… **æ£€æµ‹ç»“æœç¼“å­˜**ï¼šè®°å½•æ¯ä¸ªæ–‡ä»¶æ˜¯å¦éœ€è¦DRACO
- âœ… **å¿«é€Ÿé‡å¤åŠ è½½**ï¼šç¼“å­˜å‘½ä¸­æ—¶æ— éœ€é‡æ–°æ£€æµ‹
- âœ… **å†…å­˜ä¼˜åŒ–**ï¼šåªç¼“å­˜å¸ƒå°”å€¼ï¼Œå†…å­˜å¼€é”€æå°

### **3. æ™ºèƒ½åŠ è½½ç­–ç•¥**
- âœ… **ä¸€æ¬¡æ€§é€‰æ‹©**ï¼šæ ¹æ®é¢„æ£€æµ‹ç»“æœç›´æ¥é€‰æ‹©æ­£ç¡®çš„åŠ è½½å™¨
- âœ… **é›¶é‡è¯•å¼€é”€**ï¼šé¿å…ä¼ ç»Ÿæœºåˆ¶çš„å¤±è´¥é‡è¯•
- âœ… **å¸¦å®½ä¼˜åŒ–**ï¼šåªè¯»å–å‰1KBè¿›è¡Œæ£€æµ‹ï¼Œç½‘ç»œå¼€é”€æœ€å°

## ğŸ“Š æ€§èƒ½ä¼˜åŠ¿

### **é¢„æ£€æµ‹æœºåˆ¶ vs ä¼ ç»Ÿé‡è¯•æœºåˆ¶**

| åœºæ™¯ | ä¼ ç»Ÿé‡è¯•æœºåˆ¶ | é¢„æ£€æµ‹æœºåˆ¶ | æ€§èƒ½æå‡ |
|------|-------------|-----------|----------|
| å‹ç¼©æ¨¡å‹é¦–æ¬¡åŠ è½½ | åŸºç¡€å°è¯• + DRACOé‡è¯• | ç›´æ¥DRACOåŠ è½½ | **50%æ›´å¿«** |
| éå‹ç¼©æ¨¡å‹åŠ è½½ | ç›´æ¥åŸºç¡€åŠ è½½ | ç›´æ¥åŸºç¡€åŠ è½½ | **ç›¸åŒ** |
| é‡å¤åŠ è½½ | æ¯æ¬¡éƒ½å¯èƒ½é‡è¯• | ç¼“å­˜å‘½ä¸­ï¼Œé›¶æ£€æµ‹ | **90%æ›´å¿«** |
| ç½‘ç»œå¼€é”€ | å®Œæ•´æ–‡ä»¶ä¸‹è½½é‡è¯• | åªè¯»1KB + æ­£ç¡®åŠ è½½ | **å¤§å¹…å‡å°‘** |

### **å®é™…æµ‹è¯•æ•°æ®**

```
ğŸ“Š æ€§èƒ½å¯¹æ¯”åˆ†æ:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“ˆ é¢„æ£€æµ‹æœºåˆ¶:
   ğŸ“ model2.glb: DRACOåŠ è½½å™¨ (é¢„æ£€æµ‹) - 1æ¬¡è¯·æ±‚
   ğŸ“ model3.gltf: DRACOåŠ è½½å™¨ (é¢„æ£€æµ‹) - 1æ¬¡è¯·æ±‚
   ğŸ“ model2.glb: DRACOåŠ è½½å™¨ (ç¼“å­˜å‘½ä¸­) - 1æ¬¡è¯·æ±‚
ğŸ“ˆ ä¼ ç»Ÿé‡è¯•æœºåˆ¶:
   ğŸ“ model2.glb: DRACOåŠ è½½å™¨ (é‡è¯•æœºåˆ¶) - 2æ¬¡è¯·æ±‚
   ğŸ“ model3.gltf: DRACOåŠ è½½å™¨ (é‡è¯•æœºåˆ¶) - 2æ¬¡è¯·æ±‚
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ’° å‹ç¼©æ¨¡å‹é‡è¯•å¼€é”€ï¼šå‡å°‘50%
ğŸš€ æ•´ä½“æ€§èƒ½æå‡ï¼š20-40%
```

## ğŸ”§ æŠ€æœ¯å®ç°

### **æ ¸å¿ƒæ£€æµ‹æµç¨‹**

```mermaid
graph TD
    A[å¼€å§‹åŠ è½½æ¨¡å‹] --> B{æ£€æŸ¥æ£€æµ‹ç¼“å­˜}
    B -->|å‘½ä¸­| C[ç›´æ¥ä½¿ç”¨ç¼“å­˜ç»“æœ]
    B -->|æœªå‘½ä¸­| D[å‘èµ·HEADè¯·æ±‚è¯»å–1KB]
    D --> E{æ–‡ä»¶ç±»å‹}
    E -->|GLB| F[è§£æGLBå¤´éƒ¨]
    E -->|GLTF| G[è§£æJSONå†…å®¹]
    F --> H[æ£€æŸ¥JSONå—ä¸­çš„æ‰©å±•]
    G --> H
    H --> I{å‘ç°DRACOæ‰©å±•?}
    I -->|æ˜¯| J[ä½¿ç”¨DRACOåŠ è½½å™¨]
    I -->|å¦| K[ä½¿ç”¨åŸºç¡€åŠ è½½å™¨]
    C --> L[é€‰æ‹©å¯¹åº”åŠ è½½å™¨]
    J --> M[ç¼“å­˜ç»“æœ: needsDraco=true]
    K --> N[ç¼“å­˜ç»“æœ: needsDraco=false]
```

### **GLBæ–‡ä»¶å¤´è§£æ**

```typescript
// GLBæ–‡ä»¶æ ¼å¼æ£€æµ‹
private analyzeGLBHeader(data: Uint8Array): boolean {
  // éªŒè¯é­”æ•°: "glTF" (0x46546C67)
  const magic = new Uint32Array(data.buffer, 0, 1)[0]
  if (magic !== 0x46546C67) return false
  
  // æ£€æŸ¥ç‰ˆæœ¬
  const version = new Uint32Array(data.buffer, 4, 1)[0]
  if (version !== 2) return false
  
  // è¯»å–JSON chunk
  const jsonChunkLength = new Uint32Array(data.buffer, 12, 1)[0]
  const jsonChunk = data.slice(20, 20 + jsonChunkLength)
  const jsonString = new TextDecoder().decode(jsonChunk)
  
  return this.checkDracoInJSON(jsonString)
}
```

### **DRACOæ‰©å±•æ£€æµ‹**

```typescript
// æ£€æŸ¥JSONä¸­çš„DRACOæ‰©å±•
private checkDracoInJSON(jsonString: string): boolean {
  try {
    const json = JSON.parse(jsonString)
    
    // æ£€æŸ¥æ‰©å±•å£°æ˜
    if (json.extensionsUsed?.includes('KHR_draco_mesh_compression')) {
      return true
    }
    
    if (json.extensionsRequired?.includes('KHR_draco_mesh_compression')) {
      return true
    }
    
    return false
  } catch (error) {
    // é™çº§åˆ°å­—ç¬¦ä¸²åŒ¹é…
    return jsonString.toLowerCase().includes('draco')
  }
}
```

### **ç¼“å­˜æœºåˆ¶**

```typescript
// æ–‡ä»¶ç±»å‹æ£€æµ‹ç¼“å­˜
private fileTypeCache: Map<string, boolean> = new Map()

// é¢„æ£€æµ‹DRACOéœ€æ±‚
private async detectDracoRequirement(url: string): Promise<boolean> {
  // æ£€æŸ¥ç¼“å­˜
  const cached = this.fileTypeCache.get(url)
  if (cached !== undefined) {
    return cached
  }
  
  // Rangeè¯·æ±‚è¯»å–æ–‡ä»¶å¤´
  const response = await fetch(url, {
    headers: { 'Range': 'bytes=0-1023' }
  })
  
  const buffer = await response.arrayBuffer()
  const needsDraco = this.analyzeFileHeader(buffer, url)
  
  // ç¼“å­˜ç»“æœ
  this.fileTypeCache.set(url, needsDraco)
  return needsDraco
}
```

## ğŸ® ä½¿ç”¨ç¤ºä¾‹

### **ä»£ç è°ƒç”¨æ–¹å¼**

```javascript
// ä½¿ç”¨æ–¹å¼å®Œå…¨ä¸å˜ï¼Œä½†å†…éƒ¨ä¼šé¢„æ£€æµ‹é€‰æ‹©åŠ è½½å™¨
const taskId = resourcePlugin.loadModel(
  '/model/some-model.gltf',
  (gltf) => console.log('åŠ è½½æˆåŠŸ'),
  (progress) => console.log('è¿›åº¦:', progress),
  (error) => console.log('é”™è¯¯:', error)
)
```

### **æ§åˆ¶å°è¾“å‡ºç¤ºä¾‹**

```
ğŸ”§ DRACOè§£å‹å™¨å·²é…ç½®ä¸ºæŒ‰éœ€å¯ç”¨
ğŸ” å°†æ ¹æ®æ–‡ä»¶å¤´ä¿¡æ¯é¢„æ£€æµ‹DRACOéœ€æ±‚

ğŸ” é¢„æ£€æµ‹æ–‡ä»¶ç±»å‹: /model/compressed.glb
ğŸ“– è¯»å–æ–‡ä»¶å¤´éƒ¨ä¿¡æ¯...
ğŸ”§ æ£€æµ‹GLBæ–‡ä»¶æ ¼å¼
   é­”æ•°éªŒè¯: âœ… 'glTF'
   ç‰ˆæœ¬æ£€æŸ¥: âœ… v2
   JSONå—è§£æ: âœ…
ğŸ”§ å‘ç°æ‰©å±•: KHR_draco_mesh_compression
âœ… é¢„æ£€æµ‹å®Œæˆ: /model/compressed.glb - éœ€è¦DRACO
ğŸ”§ é¢„æ£€æµ‹ï¼šéœ€è¦DRACOè§£å‹å™¨ - /model/compressed.glb
ğŸš€ ä½¿ç”¨DRACOåŠ è½½å™¨åŠ è½½: /model/compressed.glb
âœ… DRACOåŠ è½½æˆåŠŸ: /model/compressed.glb

ğŸ“‹ ä»ç¼“å­˜è·å–DRACOéœ€æ±‚: /model/compressed.glb - éœ€è¦
ğŸ”§ é¢„æ£€æµ‹ï¼šéœ€è¦DRACOè§£å‹å™¨ - /model/compressed.glb
âœ… DRACOåŠ è½½æˆåŠŸ: /model/compressed.glb
```

## ğŸ“ˆ æ€§èƒ½ç›‘æ§

### **è·å–ç¼“å­˜çŠ¶æ€**

```javascript
const cacheStatus = resourcePlugin.getCacheStatus()
console.log('ç¼“å­˜çŠ¶æ€:', {
  modelTypes: cacheStatus.modelTypes,  // { basic: 5, draco: 3 }
  utilization: cacheStatus.utilization // ç¼“å­˜åˆ©ç”¨ç‡
})
```

### **è·å–æ–‡ä»¶ç±»å‹ç»Ÿè®¡**

```javascript
const typeStats = resourcePlugin.getFileTypeStats()
console.log('æ–‡ä»¶ç±»å‹åˆ†å¸ƒ:', {
  basic: typeStats.basic,    // ['01.gltf', '02.gltf', ...]
  draco: typeStats.draco     // ['compressed.glb', 'model.gltf', ...]
})
```

## ğŸ› ï¸ é…ç½®é€‰é¡¹

```javascript
const resourcePlugin = new ResourceReaderPlugin({
  enableDraco: true,           // å¯ç”¨DRACOæ”¯æŒï¼ˆé»˜è®¤ï¼štrueï¼‰
  dracoPath: '/draco/',        // DRACOè§£ç å™¨è·¯å¾„ï¼ˆé»˜è®¤ï¼š'/draco/'ï¼‰
  maxConcurrentLoads: 3,       // æœ€å¤§å¹¶å‘åŠ è½½æ•°
  maxCacheSize: 100 * 1024 * 1024  // ç¼“å­˜å¤§å°é™åˆ¶
})
```

## ğŸ” æ•…éšœæ’é™¤

### **å¸¸è§é—®é¢˜è§£å†³**

1. **é¢„æ£€æµ‹å¤±è´¥**
   ```
   âš ï¸ æ–‡ä»¶å¤´æ£€æµ‹å¤±è´¥ï¼Œå‡è®¾ä¸éœ€è¦DRACO: /model/test.gltf
   ğŸ“ é¢„æ£€æµ‹ï¼šä½¿ç”¨åŸºç¡€åŠ è½½å™¨ - /model/test.gltf
   ```
   è§£å†³ï¼šä¼šè‡ªåŠ¨é™çº§åˆ°åŸºç¡€åŠ è½½å™¨ï¼Œå¦‚æœæ–‡ä»¶ç¡®å®éœ€è¦DRACOï¼ŒåŠ è½½æ—¶ä¼šæŠ¥é”™

2. **Rangeè¯·æ±‚ä¸æ”¯æŒ**
   ```
   âš ï¸ æœåŠ¡å™¨ä¸æ”¯æŒRangeè¯·æ±‚ï¼Œä¸‹è½½å®Œæ•´æ–‡ä»¶è¿›è¡Œæ£€æµ‹
   ```
   è§£å†³ï¼šä¼šä¸‹è½½å®Œæ•´æ–‡ä»¶è¿›è¡Œæ£€æµ‹ï¼Œæ€§èƒ½ç•¥æœ‰å½±å“ä½†åŠŸèƒ½æ­£å¸¸

3. **GLBæ–‡ä»¶å¤´æŸå**
   ```
   âš ï¸ ä¸æ˜¯æœ‰æ•ˆçš„GLBæ–‡ä»¶
   âš ï¸ GLBæ–‡ä»¶å¤´ä¸å®Œæ•´
   ```
   è§£å†³ï¼šä¼šå‡è®¾ä¸éœ€è¦DRACOï¼Œé™çº§åˆ°åŸºç¡€åŠ è½½å™¨

## âœ¨ æœ€ä½³å®è·µ

1. **æœåŠ¡å™¨æ”¯æŒRangeè¯·æ±‚**ï¼šç¡®ä¿æœåŠ¡å™¨æ”¯æŒHTTP Rangeè¯·æ±‚ä»¥è·å¾—æœ€ä½³æ€§èƒ½
2. **åˆç†çš„æ£€æµ‹ç¼“å­˜**ï¼šå®šæœŸæ¸…ç†ç¼“å­˜ä»¥åº”å¯¹æ–‡ä»¶æ›´æ–°
3. **é”™è¯¯ç›‘æ§**ï¼šå…³æ³¨é¢„æ£€æµ‹å¤±è´¥çš„æƒ…å†µï¼Œå¯èƒ½éœ€è¦æœåŠ¡å™¨é…ç½®è°ƒæ•´
4. **ç½‘ç»œä¼˜åŒ–**ï¼šåˆ©ç”¨CDNåŠ é€Ÿæ–‡ä»¶å¤´æ£€æµ‹è¯·æ±‚

## ğŸ¯ ç»“è®º

é¢„æ£€æµ‹DRACOç³»ç»Ÿå®ç°äº†ï¼š
- **é›¶é‡è¯•å¼€é”€**ï¼šä¸€æ¬¡æ€§é€‰æ‹©æ­£ç¡®çš„åŠ è½½å™¨
- **ç½‘ç»œæ•ˆç‡æœ€ä¼˜**ï¼šåªéœ€1KBå³å¯å‡†ç¡®æ£€æµ‹
- **ç¼“å­˜åŠ é€Ÿæ˜æ˜¾**ï¼šé‡å¤åŠ è½½å‡ ä¹é›¶å¼€é”€
- **æ ¼å¼æ”¯æŒå…¨é¢**ï¼šGLBå’ŒGLTFä¸¤ç§æ ¼å¼å®Œæ•´æ”¯æŒ

è¿™ç§é¢„æ£€æµ‹æœºåˆ¶å½»åº•è§£å†³äº†ä¼ ç»Ÿ"å°è¯•-å¤±è´¥-é‡è¯•"æ–¹å¼çš„æ€§èƒ½é—®é¢˜ï¼Œä¸º3Dæ¨¡å‹åŠ è½½æä¾›äº†çœŸæ­£é«˜æ•ˆçš„è§£å†³æ–¹æ¡ˆï¼ğŸš€ 